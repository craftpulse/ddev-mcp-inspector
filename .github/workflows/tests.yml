name: tests
on:
  pull_request:
  push:
    branches: [ main, master, beta, develop ]
    tags: 
      - 'v*.*.*'
      - 'v*.*.*-beta.*'

permissions:
  contents: read

jobs:
  tests:
    defaults:
      run:
        shell: bash

    strategy:
      matrix:
        ddev_version: [stable, HEAD]
        os: [ubuntu-latest]
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up DDEV
      run: |
        curl -fsSL https://raw.githubusercontent.com/ddev/ddev/master/scripts/install_ddev.sh | bash
        ddev config global --omit-containers=ddev-router

    - name: Install bats
      run: |
        sudo apt-get update
        sudo apt-get install -y bats
        
    - name: Validate add-on
      run: |
        cd tests
        bats test.bats
        
    - name: Validate add-on structure
      run: |
        # Check required files exist
        if [ ! -f "install.yaml" ]; then
          echo "Missing install.yaml"
          exit 1
        fi
        if [ ! -f "docker-compose.mcp-inspector.yaml" ]; then
          echo "Missing docker-compose.mcp-inspector.yaml"
          exit 1
        fi
        echo "Add-on structure validation passed"

  release:
    needs: tests
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') }}
        generate_release_notes: true
        files: |
          README.md
          CHANGELOG.md
          LICENSE